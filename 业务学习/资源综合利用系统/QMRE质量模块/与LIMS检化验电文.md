# 与LIMS检化验相关电文

- [与LIMS检化验相关电文](#与lims检化验相关电文)
  - [DCTE01 检验计划 发送](#dcte01-检验计划-发送)
    - [TEDC01基本信息](#tedc01基本信息)
    - [DCTE01主要功能](#dcte01主要功能)
    - [DCTE01数据处理流程](#dcte01数据处理流程)
      - [1. 接收基础数据](#1-接收基础数据)
      - [2. 获取公司账套](#2-获取公司账套)
      - [3. 数据验证](#3-数据验证)
      - [4. 委托基本信息处理](#4-委托基本信息处理)
      - [5. 检验项目数据处理](#5-检验项目数据处理)
      - [6. 质量判定处理](#6-质量判定处理)
      - [7. 记录操作日志](#7-记录操作日志)
    - [DCTE01数据结构](#dcte01数据结构)
      - [主要表](#主要表)
      - [关键字段](#关键字段)
    - [DCTE01业务规则](#dcte01业务规则)
    - [DCTE01错误处理](#dcte01错误处理)
    - [DCTE01业务价值](#dcte01业务价值)
    - [DCTE01技术特点](#dcte01技术特点)
  - [DCTE02 物料信息 发送](#dcte02-物料信息-发送)
  - [DCTE02电文发送服务功能详解](#dcte02电文发送服务功能详解)
    - [基本信息](#基本信息)
    - [主要功能](#主要功能)
    - [数据处理流程](#数据处理流程)
      - [1. 电文发送状态检查](#1-电文发送状态检查)
      - [2. 初始化电文环境](#2-初始化电文环境)
      - [3. 查询物料数据](#3-查询物料数据)
      - [4. 数据映射与转换](#4-数据映射与转换)
      - [5. 物料信息处理](#5-物料信息处理)
      - [6. 电文发送](#6-电文发送)
    - [数据来源与目标](#数据来源与目标)
    - [业务规则](#业务规则)
    - [错误处理](#错误处理)
    - [业务价值](#业务价值)
    - [技术特点](#技术特点)
  - [DCTE03 汽运进厂信息 发送](#dcte03-汽运进厂信息-发送)
    - [DCTE03基本信息](#dcte03基本信息)
    - [DCTE03主要功能](#dcte03主要功能)
    - [DCTE03数据处理流程](#dcte03数据处理流程)
    - [DCTE03数据来源与目标](#dcte03数据来源与目标)
    - [DCTE03业务规则](#dcte03业务规则)
    - [DCTE03错误处理](#dcte03错误处理)
    - [DCTE03业务价值](#dcte03业务价值)
    - [DCTE03技术特点](#dcte03技术特点)
  - [DCTE04 生产过程检验委托 发送](#dcte04-生产过程检验委托-发送)
  - [TEDC01 辅料质量检验结果信息 接收 cm\_tedc01\_rcv](#tedc01-辅料质量检验结果信息-接收-cm_tedc01_rcv)
  - [TEDC02 生产过程检验结果信息 接收 cm\_tedc02\_rcv](#tedc02-生产过程检验结果信息-接收-cm_tedc02_rcv)
  - [TEDC03 进厂组批信息 接收 cm\_tedc03\_rcv](#tedc03-进厂组批信息-接收-cm_tedc03_rcv)

## DCTE01 检验计划 发送

TEDC01电文接收服务是一个用于接收LIMS质量检验数据的关键组件，它实现了LIMS系统与质量管理系统之间的数据集成，确保检验数据能够及时纳入企业质量管理体系。

### TEDC01基本信息

- **功能名称**：LIMS质量检验数据接收
- **电文代码**：TEDC01
- **服务函数**：`f_cm_tedc01_rcv`
- **数据流向**：LIMS系统 → 质量管理系统

### DCTE01主要功能

该服务主要完成以下功能：

1. 接收LIMS系统发送的质量检验数据
2. 存储检验委托基本信息和分析项目数据
3. 根据检验数据进行质量判定
4. 根据质量判定结果执行不同的后续处理

### DCTE01数据处理流程

#### 1. 接收基础数据

- 从电文中提取操作标志（OPERATE_FLAG）
- 获取完成标志（FINISH_FLAG）
- 获取委托单号（ENTRUST_APPLY_NO）
- 获取分析项目数量（QM_NUM）
- 获取批次号（MATERIAL_BATCH_NO）
- 获取样品号（SAMPLE_NO）

#### 2. 获取公司账套

- 通过批次号从TYMREPCINFO表获取公司账套（COMPANY_CODE）
- 将获取到的公司账套应用于后续数据处理

#### 3. 数据验证

- 检查委托单号是否为空
- 检查完成标志是否有效（N-未完成，Y-已完成，S-已审核）
- 新增操作时检查是否已存在相同委托单号的记录

#### 4. 委托基本信息处理

- 根据操作标志（I-新增，U-修改）处理委托基本信息
- 设置委托基本信息（物料代码、物料名称、批次号等）
- 将委托基本信息存储到TQMRE21表

#### 5. 检验项目数据处理

- 删除已有的检验项目数据（如果存在）
- 循环处理所有分析项目（由QM_NUM指定数量）
- 将分析项目数据存储到TQMRE23表

#### 6. 质量判定处理

当完成标志为"Y"或"S"时，执行以下步骤：

1. **获取采购订单和标准信息**
   - 通过批次号查询TYMREC1表获取采购订单号
   - 通过采购订单号查询TQMRE13表获取建议标准ID

2. **更新委托信息**
   - 更新TQMRE21表中的标准ID、基础资源和订单号

3. **执行质量判定**
   - 调用`f_qmre_grade_jdg_by_std_id`函数进行质量判定
   - 获取判定结果并更新到TQMRE21表

4. **根据判定结果执行不同处理**
   - 如果判定结果为"N"或"不合格"（质量异常）：
     - 创建质量异议记录（TQMRE43表）
     - 调用`f_zy_qmyy`函数发送质量异议到PLMS系统
   - 如果判定结果正常：
     - 调用`f_zy_cgjysj_snd`函数发送给采购进厂质量系统

#### 7. 记录操作日志

- 记录委托新增或修改的操作日志
- 记录质量判定异常的日志（如果发生）

### DCTE01数据结构

#### 主要表

- **TQMRE21**：存储检验委托基本信息
- **TQMRE23**：存储分析项目及其检测值
- **TYMREPCINFO**：存储批次相关的公司账套信息
- **TYMREC1**：存储采购订单信息
- **TQMRE13**：存储检验标准信息
- **TQMRE43**：存储质量异议信息

#### 关键字段

- **MAT_SAMPLE_NO**：试样号/委托单号
- **FINISH_FLAG**：完成标志（N-未完成，Y-已完成，S-已审核）
- **ANALYSE_FLAG**：分析标志
- **JUDGE_RESULT**：判定结果
- **STD_ID**：标准ID
- **ORDER_NO**：订单号

### DCTE01业务规则

1. 委托单号不能为空
2. 完成标志只能是N、Y或S
3. 新增操作时不能存在相同委托单号的记录
4. 只有完成标志为Y或S时才进行质量判定
5. 质量判定结果决定后续处理流程：
   - 异常时发送质量异议
   - 正常时发送给采购进厂质量

### DCTE01错误处理

服务实现了完善的错误处理机制：

- 基础数据校验失败时返回错误
- 数据库操作异常时记录日志并返回错误
- 质量判定异常时记录日志但继续处理

### DCTE01业务价值

该服务在企业质量管理中具有重要价值：

1. **数据集成**：实现LIMS系统与质量管理系统的数据集成
2. **自动判定**：根据检验数据自动进行质量判定
3. **流程自动化**：根据判定结果自动触发后续业务流程
4. **质量追溯**：提供完整的质量数据记录，支持质量追溯

### DCTE01技术特点

1. 使用参数化SQL查询防止SQL注入
2. 实现完善的异常处理机制
3. 使用日志记录关键操作信息
4. 模块化设计，将质量判定和后续处理分离为独立函数

通过这个服务，企业实现了检验数据的自动接收、质量判定和后续处理，大大提高了质量管理的效率和准确性。

## DCTE02 物料信息 发送

## DCTE02电文发送服务功能详解

`f_dcte02_snd`是一个用于将资源品名信息发送给LIMS系统的服务函数。该服务实现了资源系统与LIMS系统之间的物料主数据同步，确保两个系统使用一致的物料编码和名称。

### 基本信息

- **功能名称**：资源品名发送LIMS系统
- **电文代码**：DCTE02
- **输入参数**：
  - `MAT_CODE`：物料代码
  - `DEAL_FLAG`：操作标志（I-新增，U-更新，D-删除）
  - `conn`：数据库连接对象

### 主要功能

该服务主要完成以下功能：

1. 将资源系统中的物料基本信息发送到LIMS系统
2. 提供物料代码、物料名称的数据同步
3. 建立资源系统物料与采购系统物料的映射关系

### 数据处理流程

#### 1. 电文发送状态检查

- 调用`f_get_epex_snd_status`函数检查DCTE02电文是否开启发送
- 只有在电文开启发送的情况下才继续后续处理

#### 2. 初始化电文环境

- 创建EPEX对象并初始化DCTE02电文
- 检查初始化是否成功

#### 3. 查询物料数据

- 根据物料代码查询TYMRE21表中的物料信息
- 使用参数化SQL查询防止SQL注入

#### 4. 数据映射与转换

- 将物料基本信息映射到DCTE02电文结构
- 设置操作标志、电文序号等基本信息

#### 5. 物料信息处理

- 设置物料编码（MATERIAL_ID）和物料名称（MATERIAL_NAME）
- 通过`f_gcre_get_cname_by_code`函数获取物料中文名称
- 获取对应的采购系统物料编码（MATERIAL_ID_FIR）
- 获取采购系统物料名称（MATERIAL_NAME_FIR）

#### 6. 电文发送

- 将数据设置到电文对象中
- 发送电文到LIMS系统
- 释放电文资源

### 数据来源与目标

- **数据来源**：
  - `TYMRE21`表：资源系统物料基本信息

- **数据目标**：
  - LIMS系统（通过DCTE02电文）

### 业务规则

1. 只有在电文开启发送的情况下才发送数据
2. 物料代码不能为空
3. 需要同时提供资源系统物料信息和对应的采购系统物料信息

### 错误处理

服务实现了完善的错误处理机制：

- 电文初始化失败时返回错误
- 电文设置失败时返回错误
- 电文发送失败时返回错误
- 捕获并处理所有异常

### 业务价值

该服务在企业信息系统集成中具有重要价值：

1. **主数据同步**：确保资源系统和LIMS系统使用一致的物料编码和名称
2. **系统集成**：建立资源系统与LIMS系统的物料主数据集成
3. **数据映射**：提供资源系统物料与采购系统物料的映射关系
4. **数据准确性**：减少因物料编码不一致导致的数据错误

### 技术特点

1. 使用EPEX框架进行电文处理
2. 采用参数化SQL查询防止SQL注入
3. 实现完善的异常处理机制
4. 使用日志记录关键操作信息
5. 支持电文发送开关控制，提高系统灵活性

通过这个服务，企业实现了资源系统与LIMS系统的物料主数据同步，为后续的质量检验提供了准确的物料基础数据，确保了不同系统间物料信息的一致性。

## DCTE03 汽运进厂信息 发送

`f_dcte03_snd`是一个用于将进厂磅单信息转发给LIMS检化验系统的服务函数。该服务实现了资源系统与LIMS系统之间的数据集成，确保计量信息能够及时传递到实验室信息管理系统。

### DCTE03基本信息

- **功能名称**：进厂磅单转发LIMS检化验系统
- **电文代码**：DCTE03
- **输入参数**：
  - `WORK_SEQ_NO`：工作序列号（磅单唯一标识）
  - `DEAL_FLAG`：操作标志（I-新增，U-更新，D-删除）
  - `conn`：数据库连接对象

### DCTE03主要功能

该服务主要完成以下功能：

1. 将进厂磅单信息从资源系统转发到LIMS检化验系统
2. 提供物料基本信息和计量信息的数据集成
3. 支持采购进厂和退货业务类型的数据转发

### DCTE03数据处理流程

1. **初始化电文环境**
   - 创建EPEX对象并初始化DCTE03电文
   - 检查初始化是否成功

2. **查询磅单数据**
   - 根据工作序列号查询TYMREC1表中的磅单信息
   - 筛选条件：有采购订单号且业务类型为"采购进厂"或"退货"

3. **数据映射与转换**
   - 将磅单基本信息映射到DCTE03电文结构
   - 设置操作标志、电文序号等基本信息
   - 设置计量唯一标识、计量号、车牌号等计量信息

4. **关联采购订单信息**
   - 根据采购订单号查询TYMREA1表获取相关信息
   - 设置供应商编码、供应商名称、账套等信息

5. **物料信息处理**
   - 设置物料编码和物料名称
   - 设置一级库物料编码和名称
   - 获取物料大类和中类信息

6. **数据验证**
   - 检查磅单号是否为空
   - 检查PLMS品名是否为空

7. **电文发送**
   - 检查电文是否开启发送（通过`f_get_epex_snd_status`函数）
   - 如果开启，则发送电文到LIMS系统

### DCTE03数据来源与目标

- **数据来源**：
  - `TYMREC1`表：磅单基本信息
  - `TYMREA1`表：采购订单信息

- **数据目标**：
  - LIMS检化验系统（通过DCTE03电文）

### DCTE03业务规则

1. 只处理有采购订单号的磅单
2. 只处理业务类型为"采购进厂"或"退货"的磅单
3. 磅单号不能为空
4. PLMS品名不能为空
5. 电文发送前需检查是否开启发送功能

### DCTE03错误处理

服务实现了完善的错误处理机制：

- 电文初始化失败时返回错误
- 必要字段为空时返回错误
- 电文设置失败时返回错误
- 电文发送失败时返回错误
- 捕获并处理所有异常

### DCTE03业务价值

该服务在企业信息系统集成中具有重要价值：

1. **数据一致性**：确保计量系统和实验室系统数据一致
2. **业务协同**：支持采购进厂和质量检验业务的协同
3. **自动化**：减少人工录入，提高数据准确性
4. **实时性**：实现计量数据的实时传递，提高业务效率

### DCTE03技术特点

1. 使用EPEX框架进行电文处理
2. 采用参数化SQL查询防止SQL注入
3. 实现完善的异常处理机制
4. 使用日志记录关键操作信息
5. 支持电文发送开关控制，提高系统灵活性

通过这个服务，企业实现了计量系统与实验室系统的无缝集成，为后续的质量检验提供了准确的基础数据。

## DCTE04 生产过程检验委托 发送

## TEDC01 辅料质量检验结果信息 接收 cm_tedc01_rcv

## TEDC02 生产过程检验结果信息 接收 cm_tedc02_rcv

## TEDC03 进厂组批信息 接收 cm_tedc03_rcv
