# 与LIMS检化验相关电文

- [与LIMS检化验相关电文](#与lims检化验相关电文)
  - [DCTE01 检验计划 发送](#dcte01-检验计划-发送)
    - [TEDC01基本信息](#tedc01基本信息)
    - [DCTE01主要功能](#dcte01主要功能)
    - [DCTE01数据处理流程](#dcte01数据处理流程)
      - [1. 接收基础数据](#1-接收基础数据)
      - [2. 获取公司账套](#2-获取公司账套)
      - [3. 数据验证](#3-数据验证)
      - [4. 委托基本信息处理](#4-委托基本信息处理)
      - [5. 检验项目数据处理](#5-检验项目数据处理)
      - [6. 质量判定处理](#6-质量判定处理)
      - [7. 记录操作日志](#7-记录操作日志)
    - [DCTE01数据结构](#dcte01数据结构)
      - [主要表](#主要表)
      - [关键字段](#关键字段)
    - [DCTE01业务规则](#dcte01业务规则)
    - [DCTE01错误处理](#dcte01错误处理)
    - [DCTE01业务价值](#dcte01业务价值)
    - [DCTE01技术特点](#dcte01技术特点)
  - [DCTE02 物料信息 发送](#dcte02-物料信息-发送)
  - [DCTE02电文发送服务功能详解](#dcte02电文发送服务功能详解)
    - [基本信息](#基本信息)
    - [主要功能](#主要功能)
    - [数据处理流程](#数据处理流程)
      - [1. 电文发送状态检查](#1-电文发送状态检查)
      - [2. 初始化电文环境](#2-初始化电文环境)
      - [3. 查询物料数据](#3-查询物料数据)
      - [4. 数据映射与转换](#4-数据映射与转换)
      - [5. 物料信息处理](#5-物料信息处理)
      - [6. 电文发送](#6-电文发送)
    - [数据来源与目标](#数据来源与目标)
    - [业务规则](#业务规则)
    - [错误处理](#错误处理)
    - [业务价值](#业务价值)
    - [技术特点](#技术特点)
  - [DCTE03 汽运进厂信息 发送](#dcte03-汽运进厂信息-发送)
    - [DCTE03基本信息](#dcte03基本信息)
    - [DCTE03主要功能](#dcte03主要功能)
    - [DCTE03数据处理流程](#dcte03数据处理流程)
    - [DCTE03数据来源与目标](#dcte03数据来源与目标)
    - [DCTE03业务规则](#dcte03业务规则)
    - [DCTE03错误处理](#dcte03错误处理)
    - [DCTE03业务价值](#dcte03业务价值)
    - [DCTE03技术特点](#dcte03技术特点)
  - [DCTE04 生产过程检验委托 发送](#dcte04-生产过程检验委托-发送)
  - [TEDC01 辅料质量检验结果信息 接收 cm\_tedc01\_rcv](#tedc01-辅料质量检验结果信息-接收-cm_tedc01_rcv)
  - [TEDC02 生产过程检验结果信息 接收 cm\_tedc02\_rcv](#tedc02-生产过程检验结果信息-接收-cm_tedc02_rcv)
  - [TEDC03 进厂组批信息 接收 cm\_tedc03\_rcv](#tedc03-进厂组批信息-接收-cm_tedc03_rcv)
  - [与PLMS相关电文](#与plms相关电文)
  - [R2DC03 商检质量信息\[TQMRE21，TQMRE23\]](#r2dc03-商检质量信息tqmre21tqmre23)
    - [功能概述](#功能概述)
  - [主要业务流程](#主要业务流程)
    - [1. 数据接收与准备](#1-数据接收与准备)
    - [2. 数据处理逻辑](#2-数据处理逻辑)
    - [3. 数据校验](#3-数据校验)
    - [4. 数据处理分支](#4-数据处理分支)
      - [新增操作(DEALFLAG="I")](#新增操作dealflagi)
      - [删除操作(DEALFLAG="D")](#删除操作dealflagd)
    - [R2DC03业务规则](#r2dc03业务规则)
  - [R2DC06 合金进厂批次质量实绩\[TQMRE21，TQMRE23\]](#r2dc06-合金进厂批次质量实绩tqmre21tqmre23)
  - [R2DC06主要业务流程](#r2dc06主要业务流程)
  - [R2DC06业务规则](#r2dc06业务规则)
  - [R2DC06与R2DC03的主要区别](#r2dc06与r2dc03的主要区别)
  - [R2DC09采购质量检验标准信息](#r2dc09采购质量检验标准信息)
  - [服务概述](#服务概述)
    - [1. 数据准备阶段](#1-数据准备阶段)
    - [2. 品名代码处理](#2-品名代码处理)
    - [3. 数据删除处理](#3-数据删除处理)
    - [4. 数据新增处理（DEAL\_FLAG为`I`或`U`）](#4-数据新增处理deal_flag为i或u)
      - [4.1 检验标准主表（TQMRE13）新增](#41-检验标准主表tqmre13新增)
      - [4.2 判断标准主表（TQMRE11）新增](#42-判断标准主表tqmre11新增)
      - [4.3 检验项目明细处理](#43-检验项目明细处理)
      - [4.4 标准转发](#44-标准转发)
      - [4.5 进厂检验委托更新、](#45-进厂检验委托更新)
  - [主要数据表](#主要数据表)
  - [DCR205 采购质量实绩(进厂质量) f\_zy\_cgjysj\_snd](#dcr205-采购质量实绩进厂质量-f_zy_cgjysj_snd)
    - [1. 初始化与准备](#1-初始化与准备)
    - [2. 数据查询与组装](#2-数据查询与组装)
    - [3. 订单信息处理](#3-订单信息处理)
    - [4. 物料信息补充](#4-物料信息补充)
    - [5. 特殊处理逻辑](#5-特殊处理逻辑)
    - [6. 分析项目数据处理](#6-分析项目数据处理)
      - [进厂质量业务规则](#进厂质量业务规则)
  - [DCR207采购进厂质量异议申请 f\_zy\_qmyy](#dcr207采购进厂质量异议申请-f_zy_qmyy)
  - [采购进厂质量异议申请业务规则](#采购进厂质量异议申请业务规则)
  - [采购进厂质量异议申请相关表说明](#采购进厂质量异议申请相关表说明)

## DCTE01 检验计划 发送

TEDC01电文接收服务是一个用于接收LIMS质量检验数据的关键组件，它实现了LIMS系统与质量管理系统之间的数据集成，确保检验数据能够及时纳入企业质量管理体系。

### TEDC01基本信息

- **功能名称**：LIMS质量检验数据接收
- **电文代码**：TEDC01
- **服务函数**：`f_cm_tedc01_rcv`
- **数据流向**：LIMS系统 → 质量管理系统

### DCTE01主要功能

该服务主要完成以下功能：

1. 接收LIMS系统发送的质量检验数据
2. 存储检验委托基本信息和分析项目数据
3. 根据检验数据进行质量判定
4. 根据质量判定结果执行不同的后续处理

### DCTE01数据处理流程

#### 1. 接收基础数据

- 从电文中提取操作标志（OPERATE_FLAG）
- 获取完成标志（FINISH_FLAG）
- 获取委托单号（ENTRUST_APPLY_NO）
- 获取分析项目数量（QM_NUM）
- 获取批次号（MATERIAL_BATCH_NO）
- 获取样品号（SAMPLE_NO）

#### 2. 获取公司账套

- 通过批次号从TYMREPCINFO表获取公司账套（COMPANY_CODE）
- 将获取到的公司账套应用于后续数据处理

#### 3. 数据验证

- 检查委托单号是否为空
- 检查完成标志是否有效（N-未完成，Y-已完成，S-已审核）
- 新增操作时检查是否已存在相同委托单号的记录

#### 4. 委托基本信息处理

- 根据操作标志（I-新增，U-修改）处理委托基本信息
- 设置委托基本信息（物料代码、物料名称、批次号等）
- 将委托基本信息存储到TQMRE21表

#### 5. 检验项目数据处理

- 删除已有的检验项目数据（如果存在）
- 循环处理所有分析项目（由QM_NUM指定数量）
- 将分析项目数据存储到TQMRE23表

#### 6. 质量判定处理

当完成标志为"Y"或"S"时，执行以下步骤：

1. **获取采购订单和标准信息**
   - 通过批次号查询TYMREC1表获取采购订单号
   - 通过采购订单号查询TQMRE13表获取建议标准ID

2. **更新委托信息**
   - 更新TQMRE21表中的标准ID、基础资源和订单号

3. **执行质量判定**
   - 调用`f_qmre_grade_jdg_by_std_id`函数进行质量判定
   - 获取判定结果并更新到TQMRE21表

4. **根据判定结果执行不同处理**
   - 如果判定结果为"N"或"不合格"（质量异常）：
     - 创建质量异议记录（TQMRE43表）
     - 调用`f_zy_qmyy`函数发送质量异议到PLMS系统
   - 如果判定结果正常：
     - 调用`f_zy_cgjysj_snd`函数发送给采购进厂质量系统

#### 7. 记录操作日志

- 记录委托新增或修改的操作日志
- 记录质量判定异常的日志（如果发生）

### DCTE01数据结构

#### 主要表

- **TQMRE21**：存储检验委托基本信息
- **TQMRE23**：存储分析项目及其检测值
- **TYMREPCINFO**：存储批次相关的公司账套信息
- **TYMREC1**：存储采购订单信息
- **TQMRE13**：存储检验标准信息
- **TQMRE43**：存储质量异议信息

#### 关键字段

- **MAT_SAMPLE_NO**：试样号/委托单号
- **FINISH_FLAG**：完成标志（N-未完成，Y-已完成，S-已审核）
- **ANALYSE_FLAG**：分析标志
- **JUDGE_RESULT**：判定结果
- **STD_ID**：标准ID
- **ORDER_NO**：订单号

### DCTE01业务规则

1. 委托单号不能为空
2. 完成标志只能是N、Y或S
3. 新增操作时不能存在相同委托单号的记录
4. 只有完成标志为Y或S时才进行质量判定
5. 质量判定结果决定后续处理流程：
   - 异常时发送质量异议
   - 正常时发送给采购进厂质量

### DCTE01错误处理

服务实现了完善的错误处理机制：

- 基础数据校验失败时返回错误
- 数据库操作异常时记录日志并返回错误
- 质量判定异常时记录日志但继续处理

### DCTE01业务价值

该服务在企业质量管理中具有重要价值：

1. **数据集成**：实现LIMS系统与质量管理系统的数据集成
2. **自动判定**：根据检验数据自动进行质量判定
3. **流程自动化**：根据判定结果自动触发后续业务流程
4. **质量追溯**：提供完整的质量数据记录，支持质量追溯

### DCTE01技术特点

1. 使用参数化SQL查询防止SQL注入
2. 实现完善的异常处理机制
3. 使用日志记录关键操作信息
4. 模块化设计，将质量判定和后续处理分离为独立函数

通过这个服务，企业实现了检验数据的自动接收、质量判定和后续处理，大大提高了质量管理的效率和准确性。

## DCTE02 物料信息 发送

## DCTE02电文发送服务功能详解

`f_dcte02_snd`是一个用于将资源品名信息发送给LIMS系统的服务函数。该服务实现了资源系统与LIMS系统之间的物料主数据同步，确保两个系统使用一致的物料编码和名称。

### 基本信息

- **功能名称**：资源品名发送LIMS系统
- **电文代码**：DCTE02
- **输入参数**：
  - `MAT_CODE`：物料代码
  - `DEAL_FLAG`：操作标志（I-新增，U-更新，D-删除）
  - `conn`：数据库连接对象

### 主要功能

该服务主要完成以下功能：

1. 将资源系统中的物料基本信息发送到LIMS系统
2. 提供物料代码、物料名称的数据同步
3. 建立资源系统物料与采购系统物料的映射关系

### 数据处理流程

#### 1. 电文发送状态检查

- 调用`f_get_epex_snd_status`函数检查DCTE02电文是否开启发送
- 只有在电文开启发送的情况下才继续后续处理

#### 2. 初始化电文环境

- 创建EPEX对象并初始化DCTE02电文
- 检查初始化是否成功

#### 3. 查询物料数据

- 根据物料代码查询TYMRE21表中的物料信息
- 使用参数化SQL查询防止SQL注入

#### 4. 数据映射与转换

- 将物料基本信息映射到DCTE02电文结构
- 设置操作标志、电文序号等基本信息

#### 5. 物料信息处理

- 设置物料编码（MATERIAL_ID）和物料名称（MATERIAL_NAME）
- 通过`f_gcre_get_cname_by_code`函数获取物料中文名称
- 获取对应的采购系统物料编码（MATERIAL_ID_FIR）
- 获取采购系统物料名称（MATERIAL_NAME_FIR）

#### 6. 电文发送

- 将数据设置到电文对象中
- 发送电文到LIMS系统
- 释放电文资源

### 数据来源与目标

- **数据来源**：
  - `TYMRE21`表：资源系统物料基本信息

- **数据目标**：
  - LIMS系统（通过DCTE02电文）

### 业务规则

1. 只有在电文开启发送的情况下才发送数据
2. 物料代码不能为空
3. 需要同时提供资源系统物料信息和对应的采购系统物料信息

### 错误处理

服务实现了完善的错误处理机制：

- 电文初始化失败时返回错误
- 电文设置失败时返回错误
- 电文发送失败时返回错误
- 捕获并处理所有异常

### 业务价值

该服务在企业信息系统集成中具有重要价值：

1. **主数据同步**：确保资源系统和LIMS系统使用一致的物料编码和名称
2. **系统集成**：建立资源系统与LIMS系统的物料主数据集成
3. **数据映射**：提供资源系统物料与采购系统物料的映射关系
4. **数据准确性**：减少因物料编码不一致导致的数据错误

### 技术特点

1. 使用EPEX框架进行电文处理
2. 采用参数化SQL查询防止SQL注入
3. 实现完善的异常处理机制
4. 使用日志记录关键操作信息
5. 支持电文发送开关控制，提高系统灵活性

通过这个服务，企业实现了资源系统与LIMS系统的物料主数据同步，为后续的质量检验提供了准确的物料基础数据，确保了不同系统间物料信息的一致性。

## DCTE03 汽运进厂信息 发送

`f_dcte03_snd`是一个用于将进厂磅单信息转发给LIMS检化验系统的服务函数。该服务实现了资源系统与LIMS系统之间的数据集成，确保计量信息能够及时传递到实验室信息管理系统。

### DCTE03基本信息

- **功能名称**：进厂磅单转发LIMS检化验系统
- **电文代码**：DCTE03
- **输入参数**：
  - `WORK_SEQ_NO`：工作序列号（磅单唯一标识）
  - `DEAL_FLAG`：操作标志（I-新增，U-更新，D-删除）
  - `conn`：数据库连接对象

### DCTE03主要功能

该服务主要完成以下功能：

1. 将进厂磅单信息从资源系统转发到LIMS检化验系统
2. 提供物料基本信息和计量信息的数据集成
3. 支持采购进厂和退货业务类型的数据转发

### DCTE03数据处理流程

1. **初始化电文环境**
   - 创建EPEX对象并初始化DCTE03电文
   - 检查初始化是否成功

2. **查询磅单数据**
   - 根据工作序列号查询TYMREC1表中的磅单信息
   - 筛选条件：有采购订单号且业务类型为"采购进厂"或"退货"

3. **数据映射与转换**
   - 将磅单基本信息映射到DCTE03电文结构
   - 设置操作标志、电文序号等基本信息
   - 设置计量唯一标识、计量号、车牌号等计量信息

4. **关联采购订单信息**
   - 根据采购订单号查询TYMREA1表获取相关信息
   - 设置供应商编码、供应商名称、账套等信息

5. **物料信息处理**
   - 设置物料编码和物料名称
   - 设置一级库物料编码和名称
   - 获取物料大类和中类信息

6. **数据验证**
   - 检查磅单号是否为空
   - 检查PLMS品名是否为空

7. **电文发送**
   - 检查电文是否开启发送（通过`f_get_epex_snd_status`函数）
   - 如果开启，则发送电文到LIMS系统

### DCTE03数据来源与目标

- **数据来源**：
  - `TYMREC1`表：磅单基本信息
  - `TYMREA1`表：采购订单信息

- **数据目标**：
  - LIMS检化验系统（通过DCTE03电文）

### DCTE03业务规则

1. 只处理有采购订单号的磅单
2. 只处理业务类型为"采购进厂"或"退货"的磅单
3. 磅单号不能为空
4. PLMS品名不能为空
5. 电文发送前需检查是否开启发送功能

### DCTE03错误处理

服务实现了完善的错误处理机制：

- 电文初始化失败时返回错误
- 必要字段为空时返回错误
- 电文设置失败时返回错误
- 电文发送失败时返回错误
- 捕获并处理所有异常

### DCTE03业务价值

该服务在企业信息系统集成中具有重要价值：

1. **数据一致性**：确保计量系统和实验室系统数据一致
2. **业务协同**：支持采购进厂和质量检验业务的协同
3. **自动化**：减少人工录入，提高数据准确性
4. **实时性**：实现计量数据的实时传递，提高业务效率

### DCTE03技术特点

1. 使用EPEX框架进行电文处理
2. 采用参数化SQL查询防止SQL注入
3. 实现完善的异常处理机制
4. 使用日志记录关键操作信息
5. 支持电文发送开关控制，提高系统灵活性

通过这个服务，企业实现了计量系统与实验室系统的无缝集成，为后续的质量检验提供了准确的基础数据。

## DCTE04 生产过程检验委托 发送

## TEDC01 辅料质量检验结果信息 接收 cm_tedc01_rcv

## TEDC02 生产过程检验结果信息 接收 cm_tedc02_rcv

## TEDC03 进厂组批信息 接收 cm_tedc03_rcv

## 与PLMS相关电文

## R2DC03 商检质量信息[TQMRE21，TQMRE23]

### 功能概述

R2DC03电文用于处理商检质量信息，主要操作TQMRE21和TQMRE23两个表，用于记录商检样品及其分析结果。

## 主要业务流程

### 1. 数据接收与准备

- 接收电文数据，包含处理标志(DEALFLAG)和样品信息
- 从电文中提取样品基本信息填入TQMRE21表
  - 试样号(MAT_SAMPLE_NO)
  - 物料代码(MAT_CODE)
  - 取样时间(MAT_SAMPLE_TIME)
  - 分析时刻(ANALYSE_TIME)
  - 车号(BACK1)
  - 计量申请号(BACK2)
  - 订单号(ORDER_NO)
  - 原发重量(BACK3)

### 2. 数据处理逻辑

- 设置固定值：
  - 委托类型(DELEGATE_TYPE)="SJ"
  - 数据来源(DATA_RESOURCE)="商检"
  - 记录创建者(REC_CREATOR)="R2DC03"

- 如果试样号为空，则使用订单号作为试样号

### 3. 数据校验

- 新增操作(DEALFLAG="I")时：
  - 检查是否已存在相同计量任务号且同类型的数据
  - 检查是否已存在相同试样号的记录
  - 如有重复，抛出异常阻止操作

### 4. 数据处理分支

#### 新增操作(DEALFLAG="I")

1. 插入TQMRE21表记录（样品基本信息）
2. 循环处理分析项目数据：
   - 从电文中提取分析项目信息
   - 设置TQMRE23表字段：
     - 试样号(MAT_SAMPLE_NO)
     - 分析项目代码(ANALYSE_ITEM_CODE)
     - 数据类型(DATA_TYPE)，默认为"N"
     - 分析时刻(ANALYSE_TIME)
     - 分析值：根据数据类型存入ANALYSIS_VALUE_TEXT(文本)或ANALYSIS_VALUE(数值)
   - 插入TQMRE23表记录

#### 删除操作(DEALFLAG="D")

- 删除TQMRE23表中对应试样号的记录
- 删除TQMRE21表中对应试样号的记录

### R2DC03业务规则

1. 试样号为空时使用订单号代替
2. 分析项目值根据数据类型存储在不同字段
3. 数据类型默认为"N"(数值型)
4. 不允许重复插入相同试样号的记录
5. 不允许对同一计量任务号插入相同类型的数据

## R2DC06 合金进厂批次质量实绩[TQMRE21，TQMRE23]

R2DC06电文用于处理合金进厂批次质量实绩信息，主要操作TQMRE21和TQMRE23两个表，用于记录合金进厂样品及其分析结果。

## R2DC06主要业务流程

- 接收电文数据，包含处理标志(DEALFLAG)和样品信息
- 从电文中提取样品基本信息填入TQMRE21表
  - 试样号(MAT_SAMPLE_NO)
  - 物料代码(MAT_CODE)
  - 取样时间(MAT_SAMPLE_TIME)
  - 分析时刻(ANALYSE_TIME)
  - 车号(BACK1)
  - 计量申请号(BACK2)
  - 订单号(ORDER_NO)
  - 原发重量(BACK3)

- 设置固定值：
  - 委托类型(DELEGATE_TYPE)="JC"（进厂检验）
  - 数据来源(DATA_RESOURCE)="商检"
  - 记录创建者(REC_CREATOR)="R2DC03"

- 新增操作(DEALFLAG="I")时：
  - 检查是否已存在相同计量任务号且同类型的数据
  - 检查是否已存在相同试样号的记录
  - 如有重复，抛出异常阻止操作

新增操作(DEALFLAG="I")

1. 插入TQMRE21表记录（样品基本信息）
2. 循环处理分析项目数据：
   - 从电文中提取分析项目信息
   - 设置TQMRE23表字段：
     - 试样号(MAT_SAMPLE_NO)
     - 分析项目代码(ANALYSE_ITEM_CODE)
     - 数据类型(DATA_TYPE)，默认为"N"
     - 分析时刻(ANALYSE_TIME)
     - 分析值：根据数据类型存入ANALYSIS_VALUE_TEXT(文本)或ANALYSIS_VALUE(数值)
   - 插入TQMRE23表记录

## R2DC06业务规则

1. 分析项目值根据数据类型存储在不同字段
2. 数据类型默认为"N"(数值型)
3. 不允许重复插入相同试样号的记录
4. 不允许对同一计量任务号插入相同类型的数据

## R2DC06与R2DC03的主要区别

1. 委托类型不同：
   - R2DC06: DELEGATE_TYPE="JC"（进厂检验）
   - R2DC03: DELEGATE_TYPE="SJ"（商检）
2. R2DC06没有试样号为空时使用订单号代替的逻辑

## R2DC09采购质量检验标准信息

## 服务概述

R2DC09服务主要处理采购质量检验标准信息的接收，用于接收和处理合同指标电文。该服务将接收到的检验标准信息存储到系统中，并在必要时转发给LIMS系统。

### 1. 数据准备阶段

- 接收电文数据，获取操作标志（DEAL_FLAG）：
  - `I`：新增
  - `D`：删除
  - `U`：更新
- 获取分析项目数量（ANALYSE_ITEM_NUM）
- 从电文中提取基础信息到TYMREA1模型

### 2. 品名代码处理

- 检查采购品名代码（PSCS_MAT_CODE）是否存在
- 如果存在采购订单号（BUY_ORDER_NO），则获取公司代码（COMPANY_CODE）
- 如果资源系统品名代码（MAT_CODE）为空，则通过采购品名代码获取对应的资源系统品名代码
  - 如果无法获取对应的资源系统品名代码，则返回错误

### 3. 数据删除处理

- 如果采购订单已存在检验标准，则先删除已有数据
  - 删除TQMRE13和TQMRE14表中的相关记录
- 如果采购订单已存在判定标准，则先删除已有数据
  - 删除TQMRE11和TQMRE12表中的相关记录
- 如果操作标志为`D`（删除），则调用`f_dcte01_snd`函数将删除操作转发给LIMS系统

### 4. 数据新增处理（DEAL_FLAG为`I`或`U`）

#### 4.1 检验标准主表（TQMRE13）新增

- 生成检验标准ID（STD_ID）：`JY_yyMMdd_序列号`
- 设置工作序列号（WORK_SEQ_NO）等于STD_ID
- 设置检验标志（CHECK_FLAG）为`9`（已审核）
- 设置检验类别（SAMPLE_TYPE_CODE）为`JC`（进厂检验）
- 插入TQMRE13表记录

#### 4.2 判断标准主表（TQMRE11）新增

- 生成判断标准序列号（JDG_STD_SEQ_NO）：`PD-yyMMdd-序列号`
- 设置标准类型（STD_TYPE）为`JC`（进厂化验）
- 设置判定类型（JDG_TYPE）为`0`（进厂判定）
- 设置判定等级（JDG_GRADE）为`0`（合格品）
- 设置检验标志（CHECK_FLAG）为`9`
- 设置生效日期（EFFECT_DATE）为当前日期
- 检查是否存在重复记录，如存在则返回错误
- 插入TQMRE11表记录

#### 4.3 检验项目明细处理

- 循环处理每个分析项目（共ITEM_NUM个）：
  - 获取分析项目代码（ANALYSE_ITEM_CODE）
  - 如果项目代码为空，则跳过当前项目
  
  - 检验标准明细表（TQMRE14）处理：
    - 生成工作序列号1（WORK_SEQ_NO1）
    - 设置小数位数（DECIMAL_DIGIT）默认为3
    - 插入TQMRE14表记录
  
  - 判断标准明细表（TQMRE12）处理：
    - 设置最小值（ANALYSE_ITEM_MIN）和最大值（ANALYSE_ITEM_MAX）
    - 设置最小值比较模式（ANLY_MIN_COMP_MODE）和最大值比较模式（ANLY_MAX_COMP_MODE）
    - 设置判定需要标志（JDG_NEED_FLAG）默认为`Y`
    - 生成分析项目序列号（ANALYSE_ITEM_SEQ_NO）
    - 插入TQMRE12表记录

#### 4.4 标准转发

- 调用`f_dcte01_snd`函数将标准信息转发给LIMS系统

#### 4.5 进厂检验委托更新、

- 如果存在对应的进厂检验委托（TQMRE27表中有记录），则更新其检验标准ID
- 删除原有的检验项目明细（TQMRE28表）
- 根据新的检验标准重新添加检验项目明细

## 主要数据表

- TQMRE13/TQMRE14：检验标准静态表/项目静态表
- TQMRE11/TQMRE12：判定标准静态表/项目静态表
- TQMRE27/TQMRE28：进厂检验委托主表/明细表
- TYMREA1：采购订单表
- TYMREPM：采购品名信息表
- TQMRE03：资源分析项目代码定义静态表
- TQMRE0Z：资源质量查询分析项目显示配置表

## DCR205 采购质量实绩(进厂质量) f_zy_cgjysj_snd

该服务用于将进厂质量检验实绩数据发送给采购系统，通过DCR205电文将质量检验结果传递给相关业务系统。

### 1. 初始化与准备

- 接收参数：试样号(MAT_SAMPLE_NO)和处理标志(DEAL_FLAG)
- 初始化DCR205电文对象
- 记录操作日志

### 2. 数据查询与组装

- 从TQMRE21表查询样品基本信息
- 根据样品信息填充DCR205电文内容：
  - 操作标志(DEAL_FLAG)
  - 物料试样号(SAMPLE_NO)
  - 批次号(SAMPLE_ENTR_NO)
  - 采购订单号(BUY_ORDER_NO)

### 3. 订单信息处理

- 校验采购订单号不能为空
- 从TYMREA1表查询订单相关信息：
  - 采购物料代码(PSCS_MAT_CODE)
  - 物料代码(MAT_PROD_CODE)
  - 供应商代码(SUPPLIER_CODE)和名称(SUPPLIER_CNAME)
  - 采购账套(PUR_BILL_TO)
  - 运输方式(TRNP_CODE)
  - 发放号(SEND_NO)
  - 船名(SHIP_CNAME)
  - 始发站(START_STATION)

### 4. 物料信息补充

- 根据物料代码获取物料中文名称(MAT_PROD_CNAME)
- 根据采购物料代码获取采购品名中文(PSCS_MAT_CNAME)
- 设置取样时刻(MAT_SAMPLE_TIME)和分析时刻(ANALYSIS_TIME)
- 初始化湿重、干重、水分和车数为0

### 5. 特殊处理逻辑

- 当DEAL_FLAG为"T"时的特殊处理：
  - 将DEAL_FLAG修改为"I"
  - 批次号和试样号末尾添加"T"

### 6. 分析项目数据处理

- 从TQMRE23表查询分析项目数据（排除判定结果项目"JC3Z2"）
- 循环处理每个分析项目：
  - 设置分析项目代码(ANALYSE_ITEM_CODE)
  - 设置分析项目值(ANALYSE_VALUE)
  - 设置数据类型(ANALYSE_VALUE_TYPE)
  - 设置计量单位(ANALYSE_UNIT)
  - 根据TQMRE25表判断项目是否合格(IS_ELIGIBLE)
    - 若TQMRE25中存在对应记录，则设为"N"(不合格)
    - 否则设为"Y"(合格)
- 设置分析项目总数(ITEM_NUM)

#### 进厂质量业务规则

1. 采购订单号不能为空
2. 采购物料代码不能为空
3. 分析项目中排除判定结果项目(JC3Z2)
4. 根据TQMRE25表判断分析项目是否合格
5. 处理标志为"T"时有特殊处理逻辑

相关表说明

- TQMRE21：资源原料试样检化验履历主表-试样信息表
- TQMRE23：资源原料试样检化验履历子表-分析项目结果表
- TQMRE25：资源原料试样检化验履历子表-判定不合格信息
- TQMRE27：资源原料试样检化验履历子表-委托信息表
- TYMREA1：采购订单信息表

## DCR207采购进厂质量异议申请 f_zy_qmyy

该服务用于处理质量异议申请，通过DCR207电文将质量异议信息发送给相关业务系统，主要操作TQMRE43表中的质量异议数据。

- 接收参数：异议编号(RMA_NO)和处理标志(DEAL_FLAG)
- 初始化DCR207电文对象
- 记录操作日志

- 从TQMRE43表查询质量异议基本信息
- 根据异议信息填充DCR207电文内容：
  - 操作标志(DEAL_FLAG)
  - 异议编号(RMA_NO)
  - 异议日期(RMA_INPUT_DATE)
  - 试样编号(SAMPLE_NO)
  - 进厂批次号(IN_BATCH_NO)
  - 采购订单号(BUY_ORDER_NO)

- 校验采购订单号不能为空
- 从TYMREA1表查询订单相关信息：
  - 采购物料代码(PSCS_MAT_CODE)
  - 物料代码(MAT_CODE)
  - 供应商代码(SUPPLIER_ID)和名称(SUPPLIER_NAME)
  - 采购账套(PUR_BILL_TO)

- 根据物料代码获取物料中文名称(MAT_CNAME)
- 根据采购物料代码获取采购品名中文(PSCS_MAT_CNAME)
- 设置异议说明(RMA_DESCRIPTION)为空格
- 设置异议类型(RMA_TYPE)为"QL"(质量异议)

- 从TQMRE25表查询不合格分析项目数据（排除判定结果项目"JC3Z2"）
- 循环处理每个不合格项目：
  - 设置分析项目代码(ANALYSE_ITEM_CODE)
  - 设置分析项目值(ANALYSIS_VALUE)
- 设置不合格分析项目总数(ANALYSE_ITEM_NUM)

## 采购进厂质量异议申请业务规则

1. 采购订单号不能为空
2. 采购物料代码不能为空
3. 异议类型固定为"QL"(质量异议)
4. 分析项目中排除判定结果项目(JC3Z2)
5. 只发送不合格的分析项目数据

## 采购进厂质量异议申请相关表说明

- TQMRE43：质量异议主表
- TQMRE25：资源原料试样检化验履历子表-判定不合格信息表
- TYMREA1：采购订单信息表
