# 测试步骤详解

1. 首先由PLMS采购系统通过电文R2DC01采购物料代码发送要测试的品名到资源系统，根据PSCS_MAT_CODE以及COMPANY_CODE是否存在TYMREPM表中来进行对应的操作
2. 资源分区在XYMREPM界面进行采购品名与资源品名的维护
3. 资源分区通过DCR201采购物料代码发送资源品名与采购品名的对应关系
4. 然后资源分区通过XPSREA1FG废钢采购需求计划页面制定采购需求计划发送给PLMS系统,新增计划填入相关数据后确认之后提交。会调用psrea1_cfm，其中通过f_gcre_get_cname_by_code获取物料中文名，并通过调用f_zy_cgjh_snd中的电文DCR202采购需求计划发送采购需求计划给PLMS系统
5. PLMS接收到采购需求计划后发送采购订单、采购商检质量以及采购检验指标到资源分区
    - **R2DC02采购物料订单接收**先查询TYMREA1采购订单表。通过采购品名查询资源品名，再通过品名查询模块名并根据BUY_ORDER_NO采购订单合同号更新TYMREA1表。如果TYMRE41表资源供应商静态表中ORG_CODE不存在传入的TYMREA1表中的SUPPLIER_CODE则新增该条数据，如果存在则进行对应的字段更新。如果DEAL_FLAG为D则删除TYMREC1表中BUY_ORDER_NO为传入数据的记录
    - **R2DC03采购商检质量**如果TQMRE21资源原料试样检化验履历主表--试样信息表的MAT_SAMPLE_NO试样号为空则将MAT_SAMPLE_NO字段的值赋为TQMRE21["ORDER_NO"],再去判断计量号和接收类型标识，分为原发/商检是否为空。若不为空则获取传输电文的循环指示字段itemnum作为插入TQMRE23资源原料试样检化验履历子表--分析项目结果表的循环次数标识。
    - **R2DC09采购检验指标**如果TYMREA1采购订单表的PSCS_MAT_CODE采购物料代码字段不为空，并且TYMREA1中的采购订单唯一，更新TQMRE13检验标准静态表和TQMRE11资源原料判定标准静态表中的相应字段。然后TQMRE13表中的物料代码MAT_CODE字段不为空，通过f_gcre_get_cname_by_code("PSCS_TO_MAT", COMPANY_CODE, TYMREA1["PSCS_MAT_CODE"].ToString(), conn);//根据采购品名代码获取资源系统品名代码。将TQMRE13的MAT_CODE字段赋给TQMRE11。再去TYMREPM表查询采购物料代码
    PSCS_MAT_CODE以及TYMREA1采购订单合同BUY_ORDER_NO不为空的话。对TQMRE13表进行查询字段为BUY_ORDER_NO,BASE_RESOURCE，若存在检验标准则先对其删除然后转发检化验f_dcte01_snd( TQMRE13_D["STD_ID"].ToString().Trim(), DEAL_FLAG, conn)。同理对TQMRE11资源原料判定标准静态表进行判定，若有数据则先删除再进行新增。再根据ITEM_NUM循环处理每个分析项目：插入TQMRE14检验项目静态表。然后根据采购订单合同号更新进厂检验委托对应的检验标准TQMRE27资源原料试样检化验履历子表--委托信息表。
6. 资源分区接收数据将采购检验指标，自动转发LIMS系统DCTE01检验计划。接收传入的STD_ID检验标准ID然后去TQMRE13检验标准静态表查询该条记录是否唯一，若唯一则通过TQMRE13检验标准静态表的BUY_ORDER_NO采购订单合同号查询TYMREA1采购订单表该条记录是否唯一，若唯一则将该条记录的SUPPLIER_CODE以及SUPPLIER_CNAME赋值给XDCTE01电文结构体的对应字段
7. XYMREA1FG资源分区接收查询采购订单信息
8. 无卡计量发送配车信息、计量委托、计量实绩给资源分区
    - **TADC05配车信息**接收配车信息并将其存入TYMRECAR配车信息表中，根据DEAL_FLAG进行后续操作，如果PLAN_NO有则先删除再新增。
    - **TADC01计量委托信息**接收计划号PLAN_NO，车号TRUCK_NO，榜单号WEIGH_APP_NO。首先在TYMREC1资源作业履历表中查询是否有榜单号，若无则是其他系统发送的计量委托，资源系统直接接收磅单数据。如果TYMREA1采购订单表中包含该合同号对应的唯一一条数据将TYMREA1的SUPPLIER_CODE和COMPANY_CODE赋值给TYMREC1。如果TYMREC1的物料代码不为空然后去查询TYMRE21品名静态表去根据采购品名找到资源品名f_gcre_get_cname_by_code("PSCS_TO_MAT", s.company_code, TYMREC1["MAT_CODE"].ToString(), conn)。将TYMREC1的相关信息进行更新并获取模块与库区f_gcre_get_cname_by_code("LOAD_CODE_STOCK", s.company_code, TYMREC1["UNLOAD_CODE"].ToString(), conn)。如果C1表中采购订单合同号为空并且TPSREB1物流综合计划表中对应计划号的数据唯一，则根据物流计划号匹配TPSREB1表中的相应信息到TYMREC1表。
    - **TADC02计量实绩信息** 根据DEAL_FLAG判断记录数据进入TYMRED1计量数据履历表中，如果TYMRED1表中存在磅单号或作业流水号则删除他们。将TYMREC1的作业履历表赋值给TYMREE1 ERP抛帐履历表，然后更新TYMREC1资源作业履历表的相关计量数据。
9. 资源分区通过电文DCTE03将接收到的无卡计量计量实绩转发给LIMS系统，查询TYMREA1采购订单表，如果该采购合同订单号有且只有一条，那么更新电文结构体需要收集的数据部分进行发送。
10. LIMS通过电文TEDC03组批信息，发送组批信息到资源分区。先查询TYMREPCINFO表是否有对应的IN_BATCH_NO进厂批次号，若不存在则新增批次，设置TQMRE27资源原料试样检化验履历子表--委托信息表的基本信息，然后通过查询TYMREA1采购订单表获得供应商信息，然后调用EPGetNextSeq("QMRE_IN_BATCH_NO", conn)生成检验委托号。然后查找检验标准后插入TQMRE27表中。之后更新TQMRE28资源原料试样检化验履历子表--委托项目表的分析项目
11. LIMS再通过TEDC01辅料质量，发送辅料质量给资源分区。先检查检验委托是否存在，如果存在则删除TQMRE21资源原料试样检化验履历主表--试样信息表中对应的MAT_SAMPLE_NO物料试样号，然后根据接收到的电文数据设置委托的基本信息。如果TYMREPCINFO批次信息表能查询到进厂批次号则从TYMREPCINFO表以及TYMREA1采购订单表中获取获取对应数据。然后循环插入检验项目数据。
